#Skype for Business Online Web SDK

In this lab you will get hands-on experience developing a website with Skype for Business integration.  The sample website will allow an Office 365 user to perform the following from within their website:

1.  Sign into Skype for Business.
2.  View own presence and set status.
3.  View contact list and other user presence.
4.  View contact cards.
5.  Chat with O365 users using the conversation control.
6.  Escalate conversation to Audio/Video.

>**Prerequisites:** Before beginning the lab, the following items will be needed:
>
>1.  Visual Studio 2013 and above.
>2.  At least (2) Office 365 user credentials.
>3.  Each user has the other user added to his or her contacts.
>6.  Skype for Business Web Plug-in [Download Here](need url).

##Setting up the code
1.  Open Visual Studio and click **File->Open->Project/Solution**.
2.  Navigate to `C:\\Projects\Build2016\LabA\LabAWeb.sln`.
3.  Navigate to [https://msdn.microsoft.com/en-us/office/office365/howto/add-common-consent-manually] to create your application in Azure and attain your **Client ID**.  Note this ID as it will be used later in the lab.
4.  Add your http://localhost address to your RedirectURI list in Azure.
5.  Add the same address as above /Home.html.
7.  Hit **F5** or **the Start Button** in Visual Studio.  The website should launch in Internet Explorer.

##Signing into Skype for Business
This section will instruct a user on how to add code to your website in order to connect to Skype for Business Online.

1.  Copy the Client ID from above and paste into `Scripts\Config.js`replacing the text after **clientId:**.
2.  Replace the **redirectURL** with the localhost value from step 4 in the "Setting up the code" section above. 

	```javascript
    var config = {
    version: 'sdk-samples/1.0.0', // this helps to identify telemetry generated by the samples
    apiKey: 'a42fcebd-5b43-4b89-a065-74450fb91255', // SDK DF
    apiKeyCC: '9c967f6b-a846-4df2-b43d-5167e47d81e1', // SDK+CC DF
    clientId: '98267106-694b-4df2-8e06-fbbafd8a90e7',
    authLink: 'https://login.microsoftonline.com/common/oauth2/authorize?response_type=token',
    authResource: 'https://webdir.online.lync.com',
    redirect_uri: 'https://secondonlineapp.azurewebsites.net',
};
```
3.  Open the `Scripts\Index.js` file and replace the **showSkypeLogin()** method with:

    ```javascript
     function showSkypeLogin() {
        location.assign('https://login.microsoftonline.com/common/oauth2/authorize?response_type=token' +
                '&client_id=' + config.clientId+
                '&redirect_uri=' + config.redirect_uri+
                '&resource=https://webdir.online.lync.com');
    }
    ```
	This method will redirect the website to use the tenant-based login for Office 365.  The **redirect_uri** parameter 	specifies the destination for the login result.

4.  Open `Scripts\Home.js` and paste this method into the file:

	```javascript
     Skype.initialize({
        apiKey: config.apiKeyCC
    }, function (api) {
        apiManager = api;
        client = apiManager.UIApplicationInstance;
        client.signInManager.state.changed(function (state) {
            console.log(state);
        });
       signIn();
    });
    ```
    The above code is initializing the Skype for Business Online SDK and is listening for any sign-in status changes.  The **signIn()** method will be called once the Initialize method has completed.  The sign-in will only succeed if an auth token from the AAD login was completed.
5.  Paste the **signIn()** method into `Home.js`:

	```javascript
    function signIn() {
        var params =
     {
         "auth": null,
         "client_id": config.clientId,
         "origins": ["https://webdir.online.lync.com/autodiscover/autodiscoverservice.svc/root"],
         "cors": true,
         "version": 'secondonlineapp/1.0.0.0',
         "redirect_uri": "/9c967f6b-a846-4df2-b43d-5167e47d81e1/oauth2/token/index.html",
     };
        console.log(params);
        if (client.signInManager.state() == 'SignedOut') {
            client.signInManager.signIn(
                params
            ).then(function () {
                console.log('logged in');
                loadContacts();
                showLoggedInUserData();
                conversationHandler();
                client.personsAndGroupsManager.mePerson.status.changed(function (newStatus) {
                    console.log('logged in status: ' + newStatus);
                });
            }, function (error) {
                console.log(
                    'Error signing in: ' + error || 'Cannot sign in');
            });
        }
        else {
            console.log('already logged in');
            loadContacts();
            showLoggedInUserData();
            conversationHandler();
        }
    }
    ```
    The **signIn()** params object uses the access_token returned from the login page to authenticate your user.



##Displaying Contacts, Info, and Presence
This section will outline how to retrieve Skype for Business contacts and display their information.

1.  In the `Home.js` file, paste the following method:

	```javascript
    function loadContacts() {
        var contactList = client.personsAndGroupsManager.all.persons.get().then(function (persons) {
            persons.forEach(function (person) {
                person.id.get().then(function (id) {
                    getSelectedEmployeeInfo(id.replace('sip:', ''));
                });
            });
        });
    }
    ```
    This method is responsible for retrieving all the contacts from the logged in user.
    
2.  Next, paste the **getSelectedEmployeeInfo()** method:

	```javascript
    function getSelectedEmployeeInfo(email) {
    if (email) {
        console.log('employee info: ' + email);
        var emp = email;
        var query = client.personsAndGroupsManager.createPersonSearchQuery();
        query.text(emp);
        query.limit(1);
        query.getMore().then(function (results) {
            results.forEach(function (item) {
                var person = item.result;
                var avatar = person.avatarUrl();
                var sip = person.id();
                console.log('sip:' + sip);
                $('#ContactList').append('<div id="Contact' + contactNo + '" class="contact" data-sip="' + sip + '">' +
                    '<input type="hidden" value="' + sip + '" class="contactSIP"/>' +
                    '<div class="contactName">' + person.displayName() + '</div>' +
                    '<div><img class="contactListAvatar" src="Images/default.png" /></div>' +
                    '<div class="contactPresence"></div>' +
                    '</div>');
                contactNo++;
                person.status.get().then(function (s) {
                    console.log('initial status:' + s);
                    $('[data-sip="' + person.id() + '"] .contactPresence').html(s);
                });
                person.status.changed(function (newStatus) {
                    console.log('new status:' + newStatus);
                    $('[data-sip="' + person.id() + '"] .contactPresence').html(newStatus);
                    $('#ContactsLoadingGif').hide();
                    $('#ContactList').show();
                });
                $('#selectedCall').attr('href', 'Callto:' + sip);
                $('#selectedVideo').attr('href', 'Callto:' + sip);
                person.status.subscribe();
            });
        });
    }
}
    ```
    
	The **getSelectedEmployeeInfo()** method creates the contact list and displays contact related information.  This method also subscribes to the contact presence and will update the UI accordingly.

##Chatting with Conversation Control
This section will outline how to render the Conversation Control and use it's chat functionality.  In addition to starting a conversation, this section will also instruct the developer on how to listen for incoming chat notifications.

1.  Copy the **startConversation()** method into `Home.js`:

	```javascript
	 function startConversation(sip) {
    $('#ContactList').hide();
    $('#ChatWindow').show();
    $('#ChatControlsArea').show();
    console.log(sip);
    var chatSip = sip;
    var uris = [chatSip];
    var container = document.getElementById(chatSip);
    if (!container) {
        container = document.createElement('div');
        container.id = chatSip;
        document.querySelector('#conversations').appendChild(container);
    }
    var promise = apiManager.renderConversation(container, { modalities: ['Chat'], participants: uris });
    monitor('start conversation', promise);
}
	```
	The sip of the target user must be retrieved and placed into a string array.  A container must be provided so the conversation control knows where to paint the control to.  In this example, we create a div with the SIP set to the container ID and append it as a child to the #conversations DIV.

2.  Copy the **conversationHandler()** method into `Home.js`:

	```javascript
     function conversationHandler() {
    var test = '';
    client.conversationsManager.conversations.added(function (conversation) {
        conversation.selfParticipant.chat.state.when('Notified', function () {
            var id = conversation.participants(0).person.id();
            var container = document.getElementById(id);
            if (!container) {
                container = document.createElement('div');
                container.id = id;
                document.querySelector('#conversations').appendChild(container);
            }
            else {
                document.querySelector('#conversations').removeChild(container);
            }
            var promise = apiManager.renderConversation(container, {
                modalities: ['Chat'],
                participants: [id]
            });
            monitor('start conversation', promise);
        });
    });
}
    ```
    This method uses the **conversationsManager** to listen for incoming notifications for chat requests.  If another user starts a conversation with the logged-in user, this method will pick up the notification and render the conversation control in the same way that starting a conversation occurred in the previous step.

3.  In order to end a conversation, place the following method into the `Home.js` file:

	```javascript
    function endConversation() {
    apiManager.UIApplicationInstance.conversationsManager.conversations.get().then(function (conversationsArray) {
        if (conversationsArray && conversationsArray.length > 0) {
            conversationsArray.forEach(function (element, index, array) {
                console.log("Closing existing conversation...");
                var convo = apiManager.UIApplicationInstance.conversationsManager.conversations(0);
                convo.leave();
                apiManager.UIApplicationInstance.conversationsManager.conversations.remove(element);
                $('#conversations').empty();
            });
        }
    });
    $('#ChatWindow').hide();
    $('#ChatControlsArea').hide();
    $('#ContactList').show();
}
	```
    This method cycles through each open conversation and removes it from the conversations collection.

##Connecting with Audio and Video (Preview)
The Skype for Business web SDK supports the ability for users to connect via audio and video chats using the Skype for Business Web plug-in.

1.  To start an audio chat, copy the following methods into `chat-window.js`:

	```javascript
	function startConversation(sip) {
        var person;
        GetContactFromName(sip).then(function (results) {
            results.forEach(function (result) {
                person = result.result;
            });
            console.log('Creating conversation');
            var conversation = SkypeWebApp.conversationsManager.createConversation();
            console.log('Creating participant');
            var convParticipant = conversation.createParticipant(person)
            console.log('Participant: ' + person.displayName());
            console.log('Subscribing to participant');
            subscribeToParticipant(convParticipant);
            console.log('Adding participant to conversation');
            conversation.participants.add(convParticipant);
            console.log('Adding conversation to conversationManager');
            SkypeWebApp.conversationsManager.conversations.add(conversation);
            console.log('wait_1 (5 seconds) beginning');
            setTimeout(function () {
                console.log('wait_1 finished');
                if (audioOnly == "true") {
                    conversation.audioService.start();
                } else {
                    conversation.videoService.start();
                }
            }, 5000);
        });
    }

    function GetContactFromName(contactSIP) {
        var query = SkypeWebApp.personsAndGroupsManager.createPersonSearchQuery();
        query.text(contactSIP);
        query.limit(1);
        return query.getMore();
    }

    ```
    The **startConversation(sip)** method will create a conversation object with the sip value of the contact provided.  This method will also start the audio service and start listening for audio service related events such as connected and disconnected.
    The **GetContactFromName(contactSIP)** method retrieves a person object from the SDK which is needed to create a conversation.
    
2.  In order to listen for incoming audio or video invitations, the following method needs to be created in `chat-window.js`:

	```javascript
    function subscribeToChatEvents() {
        SkypeWebApp.conversationsManager.conversations.added(function (conversation) {
            conversation.selfParticipant.audio.state.changed(function (newState, reason, oldState) {
                if (newState == 'Notified') {
                    console.log("Audio notified");
                    conversation.audioService.accept();
                }
                else if (newState == 'Connected') {
                    console.log("Connected to Audio service");
                }
                else if (newState == "Disconnected") {
                    console.log("Disconnected from audio service");
                }
            });
            conversation.selfParticipant.video.state.changed(function (newState, reason, oldState) {
                if (newState == 'Notified') {
                    conversation.videoService.accept();
                    console.log("Video notified");
                }
                else if (newState == 'Connected') {
                    console.log("Connected to Video service");
                    console.log('wait_2 (5 seconds) beginning');
                    setTimeout(function () {
                        console.log('wait_2 finished');
                        conversation.selfParticipant.video.channels(0).stream.source.sink.container.set(document.getElementById("render-self-window"));
                        conversation.selfParticipant.video.channels(0).isStarted.set(true);
                        escalated = true;
                    }, 5000);
                }
                else if (newState == "Disconnected") {
                    console.log("Disconnected from video service");
                }
            });
        });
    }
    ```
    This method will listen to incoming notifications for audio or video chat requests and start the respective service.

3. In order to listen to the added participant in the conversation, the following method needs to  be added in `chat-  window.js`

	```javascript
        function subscribeToParticipant(participant) {
        participant.video.state.changed(function (newState, reason, oldState) {
            console.log('participant video state changed');
            if (newState == 'Connected') {
                console.log("The remote participant video has connected");
                participant.video.channels(0).stream.source.sink.container.set(document.getElementById("render-participant-window"));
                participant.video.channels(0).isStarted.set(true);
                console.log("The remote participant sink set has completed");
            }
        });
    }
    ```
    This allows us to specifically monitor the state of the participant video stream state, and render the participant video when appropriate.
4.  The last method to add to the `chat-window.js` file is **endConversation()**:

	```javascript
    function endConversation(conversation) {
        conversation.videoService.stop();
        conversation.audioService.stop();
        conversation.chatService.stop();
        conversation.leave();
        SkypeWebApp.conversationsManager.conversations.remove(conversation);
        location.assign('/Home.html');
    }
    ```
    This method stops all audio, video and chat services as well as removes the conversation from the conversationManager.
    